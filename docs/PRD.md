# Product Requirements Document (PRD): locitorium

Version: 0.1.0 (Draft)
Status: In Progress
Owner: Yui Matsumura
Author: (assistant)

## 1. 背景と目的

### 1.1 解決したい課題
- 従来の地名抽出（辞書マッチ/正規表現/一般的NER）は文脈理解が弱く、同名異地、略称、行政階層、地名に見える一般名詞（店名/人名など）で誤りやすい
- LLMは文脈理解に強いが、地理的事実（実在性、正しい座標・bbox）を保証できず、ハルシネーションが実務上致命的になり得る
- 機密テキスト（国連レポート、ニュース、SNS、監視ログ等）を外部APIへ送信できない/したくないケースがある（プライバシー、主権、コスト）

### 1.2 なぜやるのか
- 文章理解（抽出・曖昧性解消）と、地理実体の同定（実在データに基づく確定）を分離し、後者をOpenStreetMap由来の根拠で確定させることで、ハルシネーションを抑えた地名解決を実現する
- セルフホスト可能な構成で再現性の高い地名解決基盤をOSSとして提供し、プライバシー重視の地理情報解析で再利用できる基盤機能にする

### 1.3 目的・ゴール
最終ゴール:
- 自然言語テキストを入力すると、文章が言及している地名を抽出し、各地名を一意な地理実体として解決して返す
- 返す情報は機械的に利用できる形（lat/lon、bbox、OSM由来ID）を中心とする
- セルフホスト運用を第一級ユースケースとして扱う（入力文を外部に送らない）

最優先（Phase 0）:
- 客観指標で「国（Country）を正確に確定できるか」を検証する
- ここが成立しない場合、地域/都市へ進んでも破綻するため、技術的な実現可能性のゲートとする

ロードマップ上の精度目標（段階的）:
- Phase 0: 国を確定（Country-level grounding）
- Phase 1: 地域/都市（Region/City-level grounding）
- 次フェーズ: 地区/ランドマーク等（District/POI-level grounding）

### 1.4 プロダクト原則
- Grounded: 出力する地理実体は、必ず実在データ（Nominatim/OSM）に裏付けられていること
- Self-host first: セルフホスト運用を第一級ユースケースとして扱う
- Safety by default: 入力サイズ制限など、壊されにくい安全策を最低限入れる
- Build for learning: まず精度・性能の成立性を検証し、過剰機能は後回しにする
- Bounded reasoning: 60秒を超える複雑な推論を前提にしない（設計で抑止する）

## 2. ターゲットユーザー

### 2.1 主なターゲット
- データ/GIS/検索エンジニア: ニュース記事・レポート・SNSの地理タグ付けや可視化/分析をしたい
- SRE/データエンジニア: 監視文面や報告から地理情報を抽出したい（将来拡張）
- LLMアプリ開発者: RAG前処理、エンティティグラフ、地理フィルタの基盤として使いたい
- プライバシー重視の組織の開発者: 外部送信なしに運用したい

### 2.2 入力ドメイン（Phase 0で扱う代表）
- ニュース記事
- SNS投稿（短文・スラング・省略・曖昧性が強い）
- 国連レポート（長文・正式名称・複合地名が多い）

## 3. フェーズ設計（重要）

### 3.1 Phase 0: フィジビリティスタディ（最優先）
目的:
- 「地名抽出→候補検索→選択」により、国を客観指標で高精度に確定できる見込みがあるか確認する
- 併せて、2000文字級の入力で性能が許容範囲に収まる見込みがあるか確認する

成果物（最小）:
- 評価用スクリプト（ローカル実行で可）
- 評価データセット（ニュース/SNS/国連レポートを含む）
- ゴールド（正解）ラベル
  - 人手ラベリング、または既にラベリング済みテキストを投入可能な形
- 指標の算出（精度と性能）
- 失敗パターンの分類と、改善仮説（候補生成、フィルタ、プロンプト、再ランキング等）

このフェーズではやらない（明確に後回し）:
- Web UI（地図表示を含む）
- バックエンド差し替え設計
- text_span（開始・終了位置）の必須化
- 種別分類の充実（toponym/admin/poi/regionなどの粒度設計）
- ポリゴン（geometry）返却
- 根拠提示（rationale/trace）をプロダクト仕様として固めること

### 3.2 Phase 1: MVP（Phase 0で見込みが立ったら）
目的:
- 実用に向けた最小の提供形（API/CLI）を整え、再現可能にする
範囲:
- 抽出→解決→結果返却（lat/lon + bbox + OSM由来ID）
- 入力サイズ制限（必須） + 簡易レート制限（可能なら）
- 認証/課金/マルチテナントは不要

## 4. 要件

## 4.1 機能要件（Phase 0）

### 4.1.1 コア処理フロー
1) 地名候補の抽出（LLM / Ollama）
- 入力テキストから地名らしき表現を抽出する
- 出力（抽出段階）は当面「抽出文字列（mention）」でよい
- text_span（開始・終了位置）は後回し

2) 候補検索（Nominatim）
- mentionごとにNominatim検索を行い、候補リストを得る
- 候補から最低限取得する情報:
  - display_name（可能なら）
  - lat/lon
  - bbox
  - osm_type, osm_id（または同等の識別子）
- Phase 0では「国の確定」が目的のため、候補からcountry相当の情報が得られるなら抽出・正規化して評価に使う

3) 選択（LLMによる文脈評価）
- 元テキストの文脈と候補リストを入力し、最も妥当な候補を選択する
- 候補が妥当でない場合は「該当なし」として落とす（無理に選ばない）

### 4.1.2 出力形式（Phase 0）
- 評価のしやすさを優先し、当面はJSONでよい
- 各解決結果に含める最小フィールド:
  - mention
  - resolved（採用候補の有無）
  - display_name（可能なら）
  - lat, lon
  - bbox
  - osm_type, osm_id
  - country_code または country_name（評価用に必要。取得方法は実装に委ねる）
  - confidence（初期はランキングでも可、可能なら0〜1）

注:
- 種別分類の粒度設計は後回し
- 根拠提示は後回し（まずマトモな結果が得られることを優先）

### 4.1.3 推論時間の上限設計（Phase 0から適用）
- 2000文字級の入力で、処理時間が60秒を超える設計は避ける
- LLMの「長考」を前提にしない
  - 例: LLM呼び出し回数やトークン量の上限、候補数の上限、段階的短絡（一定条件で打ち切り）など
- 将来的にはFunction Calling的な設計（段階的で機械的な分解と制約）により、60秒超の複雑推論を抑止できる構造を目指す（Phase 0では方針保持）

## 4.2 非機能要件（Phase 0で評価対象）

### 4.2.1 パフォーマンス（Phase 0の感覚値）
- 2000文字で30秒以内: 素晴らしい
- 60秒以上: Webサービスとして厳しいため、設計で回避する前提にする
- 代表的文章長に対してP50/P95を測る（Phase 0から計測する）

### 4.2.2 セキュリティ（最低限）
- 入力サイズ制限は必須（文字数/バイト数）
- （MVP以降）レート制限は簡易なら導入可。認証は不要

### 4.2.3 プライバシー
- 入力本文をデフォルトで永続保存しない（評価用の保存が必要なら明示的に切り替える）
- 外部ネットワークへの送信は行わない（ユーザーが外部Nominatim/LLMを指定しない限り）

## 5. 成功指標（最優先: Phase 0）

### 5.1 方針
- 客観的に計測可能で、類似タスク（NER/Entity Linking/Disambiguation）で一般的な指標を参考にする
- Phase 0では「国の確定」にフォーカスし、ここを実現可能性のゲートにする

### 5.2 精度（Phase 0: 国）
- Country Top-1 accuracy（各mentionの採用候補の国が正解国と一致した割合）
- Country Top-k accuracy（k=3/5等。候補内に正解国が含まれる割合）
- 必要に応じてMacro平均も併記（国の偏りがある場合の見え方を補正）

補足:
- 抽出（mention）自体の評価（Precision/Recall/F1）は、Phase 0では必須にしない
  - ただし既にラベリング済みデータがあるなら、参考指標として算出してもよい

### 5.3 ハルシネーション抑制
- Nominatim候補なし（または根拠不足）の場合に、座標や国を断定して返す件数を極小化する
- 「該当なし」に落とす設計を正として扱う

### 5.4 性能
- 2000文字のP50/P95
- Nominatim問い合わせ失敗率/タイムアウト率

## 6. スケジュール（案）
- M0: フィジビリティスタディ着手
  - 評価データ/指標定義（国の確定を最優先）
  - 最小パイプライン実装（抽出→候補→選択）
- M1: フィジビリティ結論
  - 国の精度指標 + 性能指標でGo/No-Go判断
  - 主要な改善レバー（仮説）を特定
- M2: MVP（見込みが立った場合のみ）
  - 最小API/CLI + 入力サイズ制限 +（可能なら簡易レート制限）
  - 配布（Docker）とQuickstart

## 7. 依存関係
- Nominatim APIが利用可能であること（セルフホスト推奨）
- Ollama APIが利用可能であること（当面固定）
- OSMデータ利用のライセンス/クレジット明記（同梱ドキュメント）

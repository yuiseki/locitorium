# ADR/001: Phase 0（国コード）フィジビリティの最小パイプライン設計（TDD前提）

- Status: Proposed
- Date: 2026-01-28
- Owner: Yui Matsumura
- Product: locitorium
- Phase: 0（Country-level grounding）

## 1. 概要

Phase 0 の目的は、自然言語テキストから「地名っぽい固有表現（mention）」を抽出し、Nominatim/OSM に基づく候補生成と、LLM による文脈評価によって「国（ISO国コード）」を高精度に確定できる見込みがあるかを、客観指標で評価することである。

本ADRは、Phase 0 を最短で回し、失敗分析と改善サイクルを回しやすい「最小パイプライン」と「評価しやすいデータ契約」を、TDD前提で確定する。

## 2. 背景・制約

- Grounded: 出力する地理実体は必ず実在データ（Nominatim/OSM）に裏付ける
- Self-host first: 入力文の外部送信なしをデフォルトにする（ローカル/Ollama + セルフホストNominatim）
- Safety by default: 入力サイズ制限などの壊されにくい安全策を最低限入れる
- Bounded reasoning: 60秒超の長考を前提にしない（設計で抑止）
- Phase 0 の正解ラベルは ISO 国コード
- Phase 0 でも mention は「地名っぽい固有表現」全般（国名そのものも含む）

## 3. 決定事項（Decision）

### 3.1 最小パイプライン（Phase 0）

原則として「1文書あたり LLM 呼び出し 2回」で固定し、上限制御と短絡を設計で担保する。

フロー:

1) mention 抽出（LLM / Ollama）
- 入力テキストから mention（文字列の配列）を抽出する
- 出力は JSON Schema による構造化出力を必須とする
- text_span（開始・終了）は Phase 0 では必須にしない（将来互換で optional）

2) 候補検索（Nominatim /search）
- mention ごとに Nominatim /search を実行し候補リストを取得する
- 取得する最小フィールド:
  - display_name（可能なら）
  - lat, lon
  - boundingbox
  - osm_type, osm_id
  - country_code（addressdetails=1 等で得られる場合。得られない場合は null を許容）
- Phase 0 では国確定が目的のため、候補から country_code を正規化して評価に使う
  - 原則: ISO 3166-1 alpha2 を大文字化して保持

3) 候補選択（LLM / Ollama）
- 元テキストの文脈と候補リストを入力し、mentionごとに最も妥当な候補を選択する
- 候補が妥当でない場合は「該当なし」を返す（無理に選ばない）
- 出力は JSON Schema による構造化出力を必須とする

### 3.2 技術選定（Python）

Python: 3.11 以上（型、async、実行基盤の安定性を優先）

採用:

- HTTP: httpx（AsyncClient）
- Retry/Backoff: tenacity（HTTP失敗やタイムアウト時の再試行）
- Schema/Model: pydantic v2（入出力のデータ契約とバリデーション、JSON Schema生成に使用）
- CLI: Typer（run/eval の最小CLI）
- Test: pytest
- HTTP Mock: pytest-httpx（httpx をネットワーク無しで確実にモック）

Phase 0 では採用しない（保留）:

- Web API（FastAPI等）、永続DB、キュー、分散処理
- ベクトル検索、埋め込みモデル、reranker の本格導入
- Web UI/地図表示
- 認証、課金、マルチテナント

### 3.3 外部インタフェース（固定）

Ollama:
- /api/generate を使用
- 非ストリーミング（stream=false）を基本
- JSON Schema を format に渡して構造化出力を強制

Nominatim:
- /search を使用
- 推奨パラメータ:
  - format=jsonv2（または json）
  - addressdetails=1
  - limit=（上限を設定）
- 候補出力に含まれる情報（例）:
  - osm_type, osm_id
  - boundingbox
  - lat, lon
  - display_name
  - address（country_code など）

## 4. データ契約（評価しやすい構造）

評価を回しやすく、差分比較しやすい形式として、入力・ゴールド・予測を JSONL（1行1文書）で統一する。

### 4.1 入力 + ゴールド（data/phase0/dataset.jsonl）

1行 = 1文書。

フィールド:

- doc_id: string（ユニーク）
- text: string
- meta: object（任意）
  - source: "news" | "sns" | "un_report" 等
  - lang: "ja" | "en" 等
  - ref: URL や出典ID（任意）
  - created_at: 任意
- mentions: array（ゴールド）
  - mention_id: string（推奨: "{doc_id}:{n}"）
  - mention: string（表層文字列）
  - iso_country: string（ISO 3166-1 alpha2 を推奨。大文字で統一）
  - start: integer | null（optional）
  - end: integer | null（optional）
  - note: string | null（任意）

注意:
- Phase 0 では start/end が無い前提でも評価が回る設計にする
- 同一文字列が複数回出る場合は mention_id で区別する

### 4.2 予測（runs/{run_id}/predictions.jsonl）

1行 = 1文書。

フィールド:

- doc_id: string
- model_info: object（再現性のため必須）
  - ollama_model: string
  - nominatim_base_url: string
  - config_hash: string（設定のハッシュ）
- results: array（mention単位）
  - mention_id: string（可能ならゴールドと同一。無い場合は pipeline で採番）
  - mention: string
  - status: "resolved" | "no_candidate" | "rejected" | "invalid_output" | "timeout"
  - selected: object | null
    - osm_type: string
    - osm_id: integer|string
    - lat: string|float
    - lon: string|float
    - bbox: array（Nominatimの boundingbox をそのまま保持）
    - display_name: string
    - country_code: string|null（ISO alpha2 大文字）
    - confidence: float|null（0.0〜1.0、暫定可）
  - candidates: array（Top-k評価と失敗分析のため保持）
    - rank: integer
    - osm_type: string
    - osm_id: integer|string
    - display_name: string
    - lat: string|float
    - lon: string|float
    - bbox: array
    - country_code: string|null
    - category: string|null（jsonv2 の場合など）
    - place_rank: integer|null（あれば）
    - importance: float|null（あれば）

この構造により:
- Top-1: selected.country_code の一致で算出
- Top-k: candidates 上位k件の country_code に正解が含まれるかで算出
- 失敗分析: status と candidates の有無/欠落で自動分類可能

## 5. アーキテクチャ（Phase 0）

### 5.1 モジュール分割

- locitorium.clients
  - ollama_client: /api/generate 呼び出し（schema指定、stream=false）
  - nominatim_client: /search 呼び出し（timeout、retry、limit、addressdetails）

- locitorium.prompts
  - extract_mentions: mention抽出用
  - resolve_candidates: 候補選択用
  - いずれも JSON Schema 前提で設計し、出力契約を崩さない

- locitorium.pipeline
  - extractor: text -> [mention]
  - candidate_generator: mention -> [candidate]
  - resolver: (text, mentions, candidates_by_mention) -> selections（該当なし含む）
  - runner: 1文書単位の実行制御（deadline/上限制御/短絡）

- locitorium.eval
  - io: dataset/predictions の読み書き
  - metrics: top1/topk、macro集計、失敗分類

- locitorium.cli
  - run: dataset を読み predictions を生成
  - eval: gold と predictions からスコア算出

### 5.2 上限制御（60秒超を避ける）

Phase 0 から必ず実装する。

- 入力: max_chars（例: 2000〜4000）で拒否
- mention: max_mentions（例: 20）
- 候補: max_candidates_per_mention（例: 10、最大でも20）
- Nominatim: 同時実行数制御（例: 5） + タイムアウト + retry上限
- LLM: 呼び出し回数を原則2回に固定（抽出1回 + 解決1回）
- 全体: doc単位の deadline（例: 30〜60秒）
  - deadline 超過時は timeout 扱いで部分結果を保存し打ち切る

## 6. ディレクトリ構成（提案）

以下を初期構成として採用する。

- pyproject.toml は依存を固定し、ローカルで再現可能にする
- src レイアウトを採用する

構成:

- locitorium/
  - pyproject.toml
  - README.md
  - docs/
    - adr/
      - 001.md
  - src/
    - locitorium/
      - __init__.py
      - config.py
      - cli.py
      - clients/
        - __init__.py
        - ollama.py
        - nominatim.py
      - models/
        - __init__.py
        - schema.py
      - prompts/
        - __init__.py
        - extract.py
        - resolve.py
      - pipeline/
        - __init__.py
        - extractor.py
        - candidates.py
        - resolver.py
        - runner.py
      - eval/
        - __init__.py
        - metrics.py
        - io.py
  - tests/
    - conftest.py
    - clients/
      - test_nominatim.py
      - test_ollama.py
    - pipeline/
      - test_extractor.py
      - test_resolver.py
      - test_runner_deadline.py
    - eval/
      - test_metrics_topk.py
  - data/
    - phase0/
      - dataset.jsonl
  - runs/
    - .gitkeep

## 7. TDD計画（必須）

Phase 0 の成果は「評価が回ること」と「改善レバーが見えること」である。
よって実装は以下の順でテストから固定する。

### 7.1 最初に書くテスト（順序）

1) データ契約テスト（models/schema.py）
- dataset.jsonl の1行が GoldDoc として parse できる
- predictions.jsonl の1行が PredDoc として parse できる
- ISO国コードの正規化（大文字化）が期待どおり
- 欠落フィールド（country_code=null 等）を許容し、評価が落ちない

2) 評価指標テスト（eval/metrics.py）
- Top-1 accuracy の算出（最小ケース、失敗ケース）
- Top-k accuracy（k=3/5）算出（候補の country_code 欠落を含む）
- Macro集計（国偏りの見え方の検証）

3) Nominatim client テスト（clients/nominatim.py）
- /search に期待パラメータが付く（format, addressdetails, limit）
- 返却 JSON から Candidate へ必要フィールドが変換される
- HTTP失敗・タイムアウト時の retry が上限内で止まる

4) Ollama client テスト（clients/ollama.py）
- /api/generate に schema を渡し、stream=false で呼べる
- 期待 JSON を parse できる
- 破損出力時に invalid_output へ落とす（またはリトライ1回まで）

5) runner 統合テスト（pipeline/runner.py）
- 疑似レスポンス（Ollama/Nominatim）をモックし end-to-end で predictions 1行が出る
- deadline 超過時に timeout へ落ち、部分結果で保存される

### 7.2 モック方針（外部アクセス禁止を保証）

- すべてのHTTP呼び出しは httpx クライアント経由に集約する
- テストでは pytest-httpx でレスポンスを固定し、実ネットワークへ出ないことを保証する
- retry（tenacity）は回数上限と例外種別を固定し、過剰リトライを防止する

## 8. 将来拡張のためのフック（Phase 0で仕込む）

- Phase 1以降の粒度拡張のため、Candidate に category/type、rank、importance/place_rank 等を保持できる構造にする
- start/end（span）は optional としてスキーマに含め、追加実装に耐える
- prompts を独立させ、抽出/選択の改善をプロンプト差し替えで回せるようにする
- clients 層を分離し、将来 geocoder の差し替えが可能な形にする（Phase 0 は Nominatim 固定）

## 9. 影響（Consequences）

良い点:
- 1文書あたり LLM 2回固定で性能上限を設計しやすい
- JSONL + candidates 保存により Top-k と失敗分析が容易
- TDDでデータ契約と評価関数を先に固定でき、改善サイクルが回しやすい

注意点:
- mention が多い文書では解決プロンプトが肥大化するため、max_mentions と候補数上限が精度・性能の主トレードオフになる
- Nominatim から country_code が得られない候補が混じり得るため、null 許容と分類（no_candidate / rejected / invalid_output）を明確にする
- モデル更新や地図データ更新で結果が変動するため、run ごとに model_info/config_hash を必ず保存する

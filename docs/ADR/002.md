# ADR/002: Phase 2 Web API (FastAPI) on port 8010

- Status: Approved
- Date: 2026-01-28
- Owner: Yui Matsumura
- Product: locitorium
- Phase: 1 (Web API)

## 1. 概要

Phase 0 のフィジビリティが成立したため、次段階（Phase 1）として Web API を追加し、HTTP 経由で地名解決パイプラインを呼び出せる形にする。最小構成として、`GET /?q=...` を受け取り、既存パイプライン（Granite4:3b + Nominatim）で処理し、JSON を返す。

## 2. 背景・目的

- Phase 0 の CLI/評価基盤は整ったため、外部システムから呼び出せる最小 API を用意する
- 既存のセルフホスト前提を維持しつつ、実運用の入り口を提供する
- 実装と運用をシンプルに保つため、FastAPI を採用する

## 3. 決定事項

### 3.1 API 仕様（最小）

- リスニングポート: 8010
- エンドポイント: `GET /`
- クエリ: `q` (必須, string)
- クエリ: `model` (任意, string。指定時は Ollama モデルを上書き)
- レスポンス: JSON（Phase 0 の `PredDoc` を基本形として返す）

例:

```
GET http://localhost:8010/?q=Trump says administration ...

GET http://localhost:8010/?q=Trump says administration ...&model=ministral-3:3b

200 OK
{
  "doc_id": "<generated>",
  "model_info": {
    "ollama_model": "granite4:3b",
    "nominatim_base_url": "https://nominatim.yuiseki.net",
    "config_hash": "..."
  },
  "results": [
    {
      "mention_id": "<generated>:0",
      "mention": "Minneapolis",
      "status": "resolved",
      "selected": {
        "osm_type": "relation",
        "osm_id": 136712,
        "lat": "44.9773",
        "lon": "-93.2655",
        "bbox": ["..."],
        "display_name": "Minneapolis, Hennepin County, Minnesota, United States",
        "country_code": "US",
        "confidence": null
      },
      "candidates": [ ... ]
    }
  ]
}
```

### 3.2 実装方針

- 既存パイプライン (`run_doc`) を呼び出し、入力 `q` を 1 文書として扱う
- `doc_id` はリクエストごとに生成する（例: UUID）
- `AppConfig` はデフォルトで `granite4:3b` を用いる
- `model` クエリ指定時は `AppConfig.ollama_model` を上書きする
- リクエスト単位でタイムアウト/例外を扱う（Phase 0 の `deadline_s` を踏襲）

### 3.3 依存関係

- FastAPI を追加
- ASGI サーバ（uvicorn）を追加

## 4. 非機能要件

- 起動時に Nominatim ヘルスチェックを行い、5xx の場合は起動失敗とする
- `q` の文字数制限（Phase 0 の `max_chars` を適用）
- 1リクエストあたりの処理時間上限（`deadline_s`）を維持

## 5. 既知の制約

- 現時点ではバッチ処理/APIキー/レート制限は未実装
- 本APIは Phase 0 パイプラインの検証用であり、性能/安定性の最適化は未着手

## 6. 影響

- CLI に加え Web API が追加され、システム統合が容易になる
- パフォーマンスはモデルサイズと Nominatim の応答に依存するため、今後の最適化が必要

## 7. ディレクトリ構成（Phase 1）

```
locitorium/
  src/
    locitorium/
      api/
        __init__.py
        app.py        # FastAPI app / routing
```
